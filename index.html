<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Your existing head content remains the same -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Credit Union Assistant</title>
    <!-- Your CSS styles remain the same -->
    <!-- ... -->
</head>
<body>
    <div class="container">
        <!-- Header and account summary remain the same -->
        
        <div class="chat-container">
            <div class="chat-header">
                <h2>Financial Assistant</h2>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    Hi there! I'm your Canvas Credit Union assistant. How can I help you today?
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('Check my balance')">Check my balance</div>
                        <div class="suggestion-chip" onclick="sendMessage('Why did my credit score change?')">Why did my credit score change?</div>
                        <div class="suggestion-chip" onclick="sendMessage('How can I save more?')">How can I save more?</div>
                        <div class="suggestion-chip" onclick="sendMessage('Help with loan options')">Help with loan options</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
    
    <script>
        // Sample user data - in a real implementation, this would come from your backend
        const userData = {
            name: "Alex Johnson",
            accounts: {
                checking: {
                    balance: 2345.82,
                    number: "****4567",
                    transactions: [
                        { date: "2025-05-06", description: "GROCERY STORE", amount: -78.34 },
                        { date: "2025-05-05", description: "PSP*PAY", amount: -42.00 },
                        { date: "2025-05-03", description: "DEPOSIT", amount: 1850.00 },
                        { date: "2025-05-01", description: "ELECTRIC COMPANY", amount: -142.56 }
                    ]
                },
                savings: {
                    balance: 5120.50,
                    number: "****7890",
                    interestRate: 1.25,
                    lastInterestAmount: 2.15
                },
                autoLoan: {
                    balance: 12489.65,
                    rate: 5.25,
                    paymentAmount: 375.42,
                    nextPaymentDate: "2025-05-15",
                    remainingPayments: 18
                }
            },
            creditScore: {
                current: 730,
                previous: 742,
                factors: ["Recent credit application", "Increased credit utilization"]
            },
            upcomingPayments: [
                { description: "Electricity Bill", amount: 145.00, dueDate: "2025-05-11" },
                { description: "Car Insurance", amount: 98.50, dueDate: "2025-05-13" },
                { description: "Gym Membership", amount: 24.99, dueDate: "2025-05-16" }
            ],
            savingsGoals: [
                { name: "Emergency Fund", target: 10000, current: 5120.50 },
                { name: "Vacation", target: 2500, current: 800 }
            ]
        };
        
        // Keep track of conversation history for context
        let messageHistory = [];
        
        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        
        // Helper function to format dates
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Function to handle user messages
        function sendUserMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message !== '') {
                sendMessage(message);
                userInput.value = '';
            }
        }
        
        // Function to handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendUserMessage();
            }
        }
        
        // Function to send a message and get a response
        async function sendMessage(message) {
            // Display user message
            const chatMessages = document.getElementById('chat-messages');
            
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.textContent = message;
            chatMessages.appendChild(userMessageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Create and show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add the user message to history for context
            messageHistory.push({
                role: 'user',
                content: message
            });
            
            try {
                // For development purposes, use the fallback response while API is not set up
                // In production, uncomment the API call and comment out the fallback
                let response;
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Use fallback for development
                response = getFallbackResponse(message);
                
                /* 
                // Uncomment for actual API implementation
                try {
                    console.log("Attempting to call API...");
                    response = await callOpenAI(message);
                    
                    // Add to conversation history
                    messageHistory.push({
                        role: 'assistant',
                        content: response
                    });
                    
                    // Keep conversation history manageable
                    if (messageHistory.length > 10) {
                        messageHistory = messageHistory.slice(messageHistory.length - 10);
                    }
                } catch (error) {
                    console.error("API error:", error);
                    response = getFallbackResponse(message);
                }
                */
                
                // Remove typing indicator
                if (typingIndicator.parentNode) {
                    chatMessages.removeChild(typingIndicator);
                }
                
                // Display bot response
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                botMessageDiv.innerHTML = response;
                chatMessages.appendChild(botMessageDiv);
                
                // Scroll to bottom after adding bot message
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error in sendMessage:', error);
                
                // Remove typing indicator if it still exists
                if (typingIndicator.parentNode) {
                    chatMessages.removeChild(typingIndicator);
                }
                
                // Use fallback as a last resort
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                botMessageDiv.innerHTML = "I'm sorry, I encountered an error. Please try again later.";
                chatMessages.appendChild(botMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Function to call OpenAI API through our backend
        async function callOpenAI(userMessage) {
            try {
                console.log("Making API call through our backend...");
                
                // Replace with your Vercel backend URL
                const BACKEND_URL = 'https://canvas-credit-union-backend.vercel.app/;
                
                // Simplified system message for training purposes
                const systemMessage = `You are a helpful financial assistant for Canvas Credit Union. 
                You have access to the following customer data:
                ${JSON.stringify(userData, null, 2)}
                
                Always respond in a friendly, helpful manner. Format your responses with HTML
                for better readability (like <br> for line breaks and <strong> for emphasis).
                
                For any questions about balance, provide the exact amount from the userData.
                For credit score questions, explain the factors affecting the score.
                For savings advice, suggest concrete actions based on their spending patterns.
                For loan questions, compare available options based on their profile.
                
                After your main response, include helpful suggestion chips in this format:
                <div class="suggestion-chips">
                    <div class="suggestion-chip" onclick="sendMessage('Question text')">Button Label</div>
                </div>`;
                
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: systemMessage
                            },
                            ...messageHistory,
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                console.log("API Response:", data);
                
                if (data.error) {
                    console.error("API Error:", data.error);
                    throw new Error(data.error.message || "Error calling API");
                }
                
                // Handle the new OpenAI API response format
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    console.error('Unexpected response format:', data);
                    throw new Error("Invalid response format from API");
                }
            } catch (error) {
                console.error('Error calling API:', error);
                throw error;
            }
        }
        
        // Function to get a fallback response if API fails
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check balance or account-related queries
            if (lowerMessage.includes('balance') || lowerMessage.includes('account') || lowerMessage.includes('check')) {
                return `Here's a summary of your accounts:<br><br>
                    <strong>Checking:</strong> ${formatCurrency(userData.accounts.checking.balance)}<br>
                    <strong>Savings:</strong> ${formatCurrency(userData.accounts.savings.balance)}<br>
                    <strong>Auto Loan:</strong> ${formatCurrency(userData.accounts.autoLoan.balance)}<br><br>
                    Would you like details about a specific account?
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('Checking details')">Checking details</div>
                        <div class="suggestion-chip" onclick="sendMessage('Savings details')">Savings details</div>
                        <div class="suggestion-chip" onclick="sendMessage('Loan details')">Loan details</div>
                    </div>`;
            }
            
            // Credit score related questions
            else if (lowerMessage.includes('credit score') || lowerMessage.includes('score')) {
                return `Your current credit score is <strong>${userData.creditScore.current}</strong>, which decreased from ${userData.creditScore.previous} last month.<br><br>
                    This change appears to be due to:<br>
                    - ${userData.creditScore.factors[0]}<br>
                    - ${userData.creditScore.factors[1]}<br><br>
                    Based on your accounts, here are personalized recommendations to improve your score.
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('How can I improve my score?')">Improve my score</div>
                        <div class="suggestion-chip" onclick="sendMessage('When will my score recover?')">When will it recover?</div>
                    </div>`;
            }
            
            // Savings related questions
            else if (lowerMessage.includes('save') || lowerMessage.includes('saving') || lowerMessage.includes('goal')) {
                return `Looking at your spending patterns, I've identified some opportunities to help you save consistently.<br><br>
                    Based on your cash flow, you could comfortably save about $175/month without feeling stretched. Here are two methods that might work for you:<br><br>
                    1. <strong>Automatic Micro-Saving:</strong> I can set up 'Round-Up Savings' where we round each purchase to the nearest dollar and transfer the difference to savings. Based on your transaction history, this would save about $45-60/month.<br><br>
                    2. <strong>Smart Scheduled Saving:</strong> I can automatically transfer $40 each week after your paycheck deposits but before your major bills. This timing works with your cash flow patterns.<br><br>
                    Would you like me to help you set up either of these options?
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('Set up Round-Up Savings')">Set up Round-Up Savings</div>
                        <div class="suggestion-chip" onclick="sendMessage('Set up Weekly Transfers')">Set up Weekly Transfers</div>
                    </div>`;
            }
            
            // Loan options
            else if (lowerMessage.includes('loan') || lowerMessage.includes('car') || lowerMessage.includes('auto')) {
                return `Based on your current financial situation, here are some options for a new car:<br><br>
                    1. <strong>Create a dedicated car savings fund</strong> - I see you already have $800 in your vacation fund. A similar approach for a car down payment would work well.<br><br>
                    2. <strong>Make extra payments on your current auto loan</strong> - Your current loan has 18 payments remaining. Paying it off sooner would free up $375.42 monthly that could go toward your next car.<br><br>
                    3. <strong>Consider a HELOC for the purchase</strong> - With your credit profile, this could be a competitive rate option.<br><br>
                    Would you like to explore any of these options in more detail?
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('Tell me about car savings funds')">Car savings fund</div>
                        <div class="suggestion-chip" onclick="sendMessage('Extra loan payments')">Extra loan payments</div>
                    </div>`;
            }
            
            // Default fallback
            else {
                return `I'm here to help with your financial questions and banking needs. Here are some things I can assist with:<br><br>
                    - Account balances and recent transactions<br>
                    - Savings goals and strategies<br>
                    - Credit score information<br>
                    - Loan options and payments<br><br>
                    What would you like help with today?
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendMessage('Check my balance')">Check my balance</div>
                        <div class="suggestion-chip" onclick="sendMessage('How can I save more?')">How can I save more?</div>
                        <div class="suggestion-chip" onclick="sendMessage('Why did my credit score change?')">Credit score info</div>
                    </div>`;
            }
        }
        
        // Event listeners - This is a key fix
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listener to button using getElementById
            const sendButton = document.getElementById('send-button');
            if (sendButton) {
                sendButton.addEventListener('click', sendUserMessage);
                console.log("Send button listener attached");
            } else {
                console.error("Send button not found in DOM");
            }
        });
    </script>
</body>
</html>
