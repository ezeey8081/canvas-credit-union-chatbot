<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Credit Union AI Chatbot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 20px;
        }

        .header {
            background-color: #1a76d2;
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .chat-box {
            height: 400px;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .user-message, .bot-message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
        }

        .user-message {
            background-color: #1a76d2;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: #f1f1f1;
            border-bottom-left-radius: 5px;
        }

        .input-area {
            display: flex;
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            border: 1px solid #ddd;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        #send-button {
            background-color: #1a76d2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .chip {
            background-color: #e0e0e0;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .chip:hover {
            background-color: #d0d0d0;
        }

        .accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .account-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            flex: 1;
            min-width: 200px;
        }

        .account-card h3 {
            margin-top: 0;
            color: #1a76d2;
        }

        .balance {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .details {
            color: #666;
            font-size: 14px;
        }

        .thinking {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: #888;
            border-radius: 50%;
            animation: thinking 1.4s infinite ease-in-out both;
        }

        .thinking-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes thinking {
            0%, 80%, 100% { 
                transform: scale(0);
            } 
            40% { 
                transform: scale(1.0);
            }
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="accounts">
            <div class="account-card">
                <h3>Checking Account</h3>
                <div class="balance">$2,345.82</div>
                <div class="details">Last transaction: 05/06/2025</div>
            </div>
            
            <div class="account-card">
                <h3>Savings Account</h3>
                <div class="balance">$5,120.50</div>
                <div class="details">Interest earned: $2.15</div>
            </div>
            
            <div class="account-card">
                <h3>Auto Loan</h3>
                <div class="balance">$12,489.65</div>
                <div class="details">Next payment: 05/15/2025</div>
            </div>
        </div>

        <div class="header">
            <h1>Canvas Credit Union Assistant</h1>
        </div>
        
        <div class="chat-box" id="chat-box">
            <!-- Initial bot message will be added by JavaScript -->
        </div>
        
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // User data model for context enhancement
        const userData = {
            customer: {
                name: "Alex Johnson",
                since: "2018",
                creditScore: 730,
                previousCreditScore: 742
            },
            accounts: {
                checking: { 
                    balance: 2345.82,
                    accountNumber: "****4567",
                    transactions: [
                        { date: "2025-05-06", description: "GROCERY STORE", amount: -78.34 },
                        { date: "2025-05-05", description: "PSP*PAY", amount: -42.00 },
                        { date: "2025-05-03", description: "DEPOSIT", amount: 1850.00 },
                        { date: "2025-05-01", description: "ELECTRIC COMPANY", amount: -142.56 }
                    ]
                },
                savings: { 
                    balance: 5120.50,
                    accountNumber: "****7890",
                    interestRate: 1.25,
                    lastInterestAmount: 2.15
                },
                autoLoan: {
                    balance: 12489.65,
                    rate: 5.25,
                    paymentAmount: 375.42,
                    nextPaymentDate: "2025-05-15",
                    remainingPayments: 18
                }
            }
        };

        // Initial system message
        const systemMessage = {
            role: "system", 
            content: `You are an AI assistant for Canvas Credit Union. You help customers with their banking needs and financial questions.

Here is customer information you have access to:
${JSON.stringify(userData, null, 2)}

Always respond in a friendly, helpful manner. Format your responses with HTML when it improves readability (like <br> for line breaks or <strong> for emphasis).

For any questions about account balances, provide the exact amount from the userData.
For credit score questions, explain the 12-point decrease from 742 to 730 is likely due to recent credit applications or increased utilization.
For savings advice, suggest concrete actions based on their spending patterns.
For loan questions, provide information about their auto loan and available options.

Keep responses concise and helpful. Do not mention that you're an AI or that you have limited knowledge - just be helpful.
Do not include any suggestion chips in your response - those will be added separately.`
        };

        // Conversation history for context
        let conversationHistory = [
            systemMessage,
            {
                role: "assistant",
                content: "Hi there! I'm your Canvas Credit Union assistant. How can I help you today?"
            }
        ];

        // Common suggestion chips to display after bot messages
        const commonChips = [
            { label: 'Check my balance', message: 'Check my balance' },
            { label: 'Credit score', message: 'Why did my credit score change?' },
            { label: 'Saving tips', message: 'How can I save more?' },
            { label: 'Loan options', message: 'Help with loan options' }
        ];

        // Get DOM elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // Display initial welcome message
        document.addEventListener('DOMContentLoaded', function() {
            // Send button click event
            sendButton.addEventListener('click', sendMessage);
            
            // Enter key press event
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Add initial bot message
            addBotMessage(conversationHistory[1].content, commonChips);
        });

        // Function to send a message from input field
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message !== '') {
                addUserMessage(message);
                sendToChatGPT(message);
                messageInput.value = '';
            }
        }

        // Function to send a message from suggestion chips
        function sendChipMessage(message) {
            addUserMessage(message);
            sendToChatGPT(message);
        }

        // Function to add user message to chat
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'user-message';
            messageElement.textContent = message;
            chatBox.appendChild(messageElement);
            scrollToBottom();

            // Add to conversation history
            conversationHistory.push({
                role: "user",
                content: message
            });
        }

        // Function to add bot message to chat
        function addBotMessage(message, chips = commonChips) {
            const messageElement = document.createElement('div');
            messageElement.className = 'bot-message';
            
            // Set the HTML content
            messageElement.innerHTML = message;
            
            // Add suggestion chips
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestion-chips';
            
            chips.forEach(chip => {
                const chipElement = document.createElement('div');
                chipElement.className = 'chip';
                chipElement.textContent = chip.label;
                chipElement.onclick = function() {
                    sendChipMessage(chip.message);
                };
                suggestionsDiv.appendChild(chipElement);
            });
            
            messageElement.appendChild(suggestionsDiv);
            
            chatBox.appendChild(messageElement);
            scrollToBottom();
        }

        // Function to show thinking indicator
        function showThinkingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'bot-message';
            indicator.id = 'thinking-indicator';
            
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking';
            
            // Add three dots for the animation
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'thinking-dot';
                thinkingDiv.appendChild(dot);
            }
            
            indicator.appendChild(thinkingDiv);
            chatBox.appendChild(indicator);
            scrollToBottom();
        }

        // Function to remove thinking indicator
        function removeThinkingIndicator() {
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) {
                chatBox.removeChild(indicator);
            }
        }

        // Function to scroll chat to bottom
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Determine appropriate chips based on the message context
        function getContextSpecificChips(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('balance') || lowerMessage.includes('account')) {
                return [
                    { label: 'Checking details', message: 'Tell me about my checking account' },
                    { label: 'Savings details', message: 'Tell me about my savings account' },
                    { label: 'Loan details', message: 'Tell me about my auto loan' }
                ];
            }
            else if (lowerMessage.includes('credit score')) {
                return [
                    { label: 'Improve my score', message: 'How can I improve my credit score?' },
                    { label: 'Credit report', message: 'How do I get my credit report?' },
                    { label: 'Score factors', message: 'What factors affect my credit score?' }
                ];
            }
            else if (lowerMessage.includes('saving') || lowerMessage.includes('save')) {
                return [
                    { label: 'Round-Up Savings', message: 'Tell me more about Round-Up Savings' },
                    { label: 'Weekly Transfers', message: 'Tell me about automatic transfers' },
                    { label: 'Savings Calculator', message: 'How much should I save each month?' }
                ];
            }
            else if (lowerMessage.includes('loan')) {
                return [
                    { label: 'Extra payments', message: 'How do extra payments help?' },
                    { label: 'Refinance options', message: 'Tell me about refinancing' },
                    { label: 'Payoff date', message: 'When will my loan be paid off?' }
                ];
            }
            
            // Default to common chips
            return commonChips;
        }

        // Function to send message to backend that will relay to ChatGPT
        async function sendToChatGPT(message) {
            // Show thinking indicator
            showThinkingIndicator();
            
            try {
                // Backend URL - your Vercel deployment
                const backendUrl = 'https://canvas-credit-union-backend.vercel.app/api/chat';
                
                console.log('Sending to backend:', conversationHistory);
                
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        temperature: 0.7,
                    })
                });
                
                console.log('Backend response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Backend response data:', data);
                
                // Remove thinking indicator
                removeThinkingIndicator();
                
                // Process the response based on the format returned
                if (data && data.choices && data.choices.length > 0) {
                    let assistantMessage;
                    
                    // Check if the response format has message.content (OpenAI API v1) or just content (direct response)
                    if (data.choices[0].message && data.choices[0].message.content) {
                        assistantMessage = data.choices[0].message.content;
                    } else if (data.choices[0].content) {
                        assistantMessage = data.choices[0].content;
                    } else {
                        console.error('Unexpected response format:', data);
                        throw new Error('Unexpected response format from API');
                    }
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: "assistant",
                        content: assistantMessage
                    });
                    
                    // Trim conversation history if it gets too long
                    if (conversationHistory.length > 20) {
                        const systemMsg = conversationHistory[0];
                        conversationHistory = [
                            systemMsg,
                            ...conversationHistory.slice(-10)
                        ];
                    }
                    
                    // Determine appropriate suggestion chips based on the message
                    const contextChips = getContextSpecificChips(assistantMessage);
                    
                    // Add assistant's response to the chat
                    addBotMessage(assistantMessage, contextChips);
                } else {
                    throw new Error('Unexpected response format from API');
                }
                
            } catch (error) {
                console.error('Error sending message to AI:', error);
                
                // Remove thinking indicator
                removeThinkingIndicator();
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = "I'm having trouble connecting to our system. Please try again in a moment.";
                chatBox.appendChild(errorDiv);
                
                // Add a simple response so the user isn't left hanging
                setTimeout(() => {
                    addBotMessage("I apologize for the technical difficulty. Let me try to help you with your question. What specifically would you like to know about your accounts or financial options?");
                }, 1000);
            }
        }
    </script>
</body>
</html>
